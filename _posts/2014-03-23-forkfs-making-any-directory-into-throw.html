---
layout: post
title: 'forkfs: making any directory into a throw away directory'
date: '2014-03-23T15:43:00.000-07:00'
author: Eugene Yakubovich
tags: 
modified_time: '2014-03-23T15:43:33.425-07:00'
blogger_id: tag:blogger.com,1999:blog-7098284592115366563.post-1823836865803352202
blogger_orig_url: http://dev-perspective.blogspot.com/2014/03/forkfs-making-any-directory-into-throw.html
---

I recently needed to work on two git branches simultaneously. My particular use case required me to make small changes to both branches, rebuild and run. These were temporary changes that I was going to blow away at the end. One approach could have been to have two clones of the repo but that would have required me to rebuild my project from scratch for the second working copy (it was boost which is large). Having run into the same predicament before, I decided to create a script to "fork" a directory.<br /><br />The script, called forkfs, works as follows. Suppose you are in your bash session in directory foo:<br /><pre class="brush: shell">~/foo$ ls<br />bar<br /></pre><br />You then execute forkfs which launches a new bash session and changes your prompt to remind you that you are forked:<br /><pre class="brush: shell">~/foo$ sudo ~/bin/forkfs<br />(forkfs) ~/foo$ ls<br />bar<br /></pre><br />So far it looks like nothing has changed but if we start making changes to the contents of foo, they'll only be visible in our forked session:<br /><pre class="brush: shell">(forkfs) ~/foo$ touch baz<br />(forkfs) ~/foo$ ls<br />bar baz<br /></pre><br />Open up another bash session and do an ls there:<br /><pre class="brush: shell">~/foo$ ls<br />bar<br /></pre><div><br /></div><div>When you exit out of your forkfs session, all your changes will be lost! You can also make multiple forks of the same directory, just not a fork of a fork. The forkfs script is available on <a href="https://github.com/eyakubovich/blog-code/blob/master/forkfs/forkfs">GitHub</a>.<br /><br /></div><h3>Words Of Caution</h3>Be careful where your fork begins. If you're using it for multiple git branches like I was, be sure to fork at the repository directory -- same place that houses the .git directory. Otherwise git will be confused outside of forked session.<br /><br /><h3>Under The Hood</h3><div>The script makes use of two technologies that are also used by <a href="https://www.docker.io/">Docker</a>: aufs and mount namespaces. <a href="http://aufs.sourceforge.net/">Aufs</a>&nbsp;is a <a href="http://en.wikipedia.org/wiki/Union_mount">union filesystem</a>&nbsp;which takes multiple source directories and combines them into a single destination directory. For example, one can mount /home/johndoe such that it's a union of /home/john and /home/doe directories. When you make changes in /home/johndoe, aufs uses a preconfigured policy to figure out which underlying directory gets the changes. One such policy allows forkfs to create Copy-On-Write functionality. When forkfs is forking ~/foo:</div><div><br /></div><div>1. It creates an empty temporary directory, e.g. /tmp/tmp.Gb33ro1lrU</div><div>2. It mounts ~/foo (marked as readonly) + /tmp/tmp.Gb33ro1lrU (marked as read-write) into ~/foo:</div><pre class="brush: shell">mount -t aufs -o br=/tmp/tmp.Gb33ro1lrU=rw:~/foo=ro none ~/foo<br /></pre><div><br /></div><div>Since ~/foo was marked as read only, all the writes go to the temporary directory, achieving copy-on-write.</div><div><br /></div><div>Notice that the aufs was mounted over ~/foo. An unfortunate consequence of this is that the original ~/foo is no longer accessible. Moreover, it will not be possible to create other forks of ~/foo. This is where mount namespaces come to the rescue.</div><div><br /></div><div>Mount namespaces allow a process to inherit all of the parent's mounts but have any further mounts not be visible by its parent. Linux actually has other namespaces of which a process can get a private copy: IPC, network, host/domain names, PIDs. <a href="https://linuxcontainers.org/">Linux containers (<span id="goog_32538743"></span>LXC<span id="goog_32538744"></span>)</a>&nbsp;makes use of these to provide light-weight virtualization.</div><div><br /></div><div>unshare is a handy command to get a process running with a private namespace. forkfs uses "unshare -m bash" to get a bash running with a private mount namespace. It then executes aufs mount without having the rest of the system seeing the fork.<br /><br /></div><h3>Future Work</h3><div>If I have time, I'd like to add ability to create named forks and then be able to come back to them (like Python's virtualenv).<br /><br /></div><h3>Acknowledgements</h3><div>Special thanks goes to Vlad Didenko for helping me out with bash nuances.</div>